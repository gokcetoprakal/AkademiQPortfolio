@model List<Message>
@{
    ViewData["Title"] = "Inbox";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="ml-72 flex h-[calc(100vh-40px)] gap-6 p-4 bg-[#fdf2f5]">

    <aside class="w-96 bg-white rounded-[32px] border border-pink-50 flex flex-col shadow-sm overflow-hidden">
        <div class="p-6 border-b border-pink-50 bg-white">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-extrabold text-gray-800 tracking-tight">Inbox</h2>
                <span id="unreadCountBadge" class="text-[10px] font-black bg-pink-500 text-white px-3 py-1 rounded-full uppercase">
                    @Model.Count(x => (x.IsRead ?? false) == false) NEW
                </span>
            </div>
            <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-300 text-sm">search</span>
                <input type="text" placeholder="Search inquiries..."
                       class="w-full pl-10 pr-4 py-2.5 rounded-2xl bg-gray-50 border-none text-sm outline-none focus:ring-2 focus:ring-pink-100 transition-all placeholder:text-gray-300" />
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            @foreach (var msg in Model)
            {
                bool isUnread = !(msg.IsRead ?? false);

                <div id="msg-card-@msg.MessageId"
                     onclick="openMessage('@msg.MessageId', '@msg.SenderName', '@msg.MessageSubject', '@msg.MessageText', '@msg.SendDate?.ToString("dd MMM, HH:mm")', '@msg.SenderEmail', this)"
                     class="message-item cursor-pointer p-5 rounded-[24px] border transition-all relative group
                                @(isUnread ? "bg-pink-50/40 border-pink-100 shadow-sm" : "bg-white border-transparent hover:bg-gray-50")">

                    @if (isUnread)
                    {
                        <div class="unread-dot absolute right-5 top-6 w-2.5 h-2.5 bg-pink-500 rounded-full animate-pulse shadow-[0_0_10px_rgba(236,72,153,0.6)]"></div>
                    }

                    <div class="flex justify-between items-center mb-1">
                        <p class="font-bold text-sm text-gray-800 group-hover:text-pink-600 transition-colors">@msg.SenderName</p>
                        <span class="text-[10px] font-bold text-gray-400">@msg.SendDate?.ToString("HH:mm")</span>
                    </div>

                    <p class="text-[13px] font-bold text-gray-700 truncate mb-1">@msg.MessageSubject</p>
                    <p class="text-xs text-gray-400 line-clamp-1 italic">@msg.MessageText</p>
                </div>
            }
        </div>
    </aside>

    <section id="detailPane" class="flex-1 bg-white rounded-[40px] border border-pink-50 shadow-sm overflow-hidden flex flex-col relative">
        <div class="flex-1 flex flex-col items-center justify-center p-12 text-center bg-[#fffcfc]">
            <div class="w-32 h-32 rounded-[48px] bg-white flex items-center justify-center mb-6 shadow-xl shadow-pink-100/50 border border-pink-50">
                <span class="material-symbols-outlined text-5xl text-pink-200 animate-bounce">mail</span>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Select a message</h3>
            <p class="text-sm text-gray-400 mt-2 max-w-xs leading-relaxed">
                Click on an inquiry from the left list to read the full message details and send a reply.
            </p>
        </div>
    </section>

</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #fee2e2;
        border-radius: 20px;
    }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #fbcfe8;
        }

    .message-item.active-message {
        border-color: #ec4899 !important;
        background-color: #fff !important;
        box-shadow: 0 10px 20px -5px rgba(236, 72, 153, 0.15);
    }
</style>

<script>
    function openMessage(id, name, subject, text, date, email, element) {
        // 1. Aktif kartı işaretle
        document.querySelectorAll('.message-item').forEach(el => el.classList.remove('active-message'));
        element.classList.add('active-message');

        // 2. Sağ tarafı doldur
        const detailPane = document.getElementById('detailPane');
        detailPane.innerHTML = `
            <div class="p-8 border-b border-pink-50 bg-white flex justify-between items-center animate-in fade-in duration-300">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-2xl bg-pink-500 text-white flex items-center justify-center text-xl font-black shadow-lg shadow-pink-200">
                        ${name.charAt(0)}
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${name}</h3>
                        <p class="text-xs text-pink-500 font-bold uppercase tracking-widest">${email || 'No Email Address'}</p>
                    </div>
                </div>
                <button onclick="deleteMessage('${id}')" class="p-3 text-gray-400 hover:bg-red-50 hover:text-red-500 rounded-2xl transition-all">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
            <div class="flex-1 p-10 overflow-y-auto bg-[#fffcfc]">
                <div class="max-w-3xl mx-auto">
                    <span class="text-[10px] font-black text-gray-300 uppercase tracking-widest">${date}</span>
                    <h1 class="text-2xl font-black text-gray-800 mt-2 mb-8 leading-tight">${subject}</h1>
                    <div class="bg-white p-8 rounded-[32px] border border-pink-50 shadow-sm text-gray-600 leading-[1.8] mb-12">
                        ${text.replace(/\n/g, '<br>')}
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="material-symbols-outlined text-pink-500 text-sm">reply</span>
                            <span class="text-xs font-bold text-gray-700 uppercase">Write a Reply</span>
                        </div>
                        <div class="bg-white rounded-[32px] border border-pink-100 shadow-sm overflow-hidden focus-within:border-pink-400 transition-all">
                            <textarea id="replyContent" rows="4" placeholder="Type your message to ${name}..."
                                      class="w-full p-6 text-sm outline-none resize-none text-gray-600 placeholder:text-gray-300"></textarea>
                            <div class="p-4 bg-gray-50/50 border-t border-pink-50 flex justify-end">
                                <button onclick="sendReply('${id}', '${email}')" class="bg-pink-500 text-white px-8 py-3 rounded-2xl font-bold hover:bg-pink-600 transition-all flex items-center gap-2 shadow-lg shadow-pink-100">
                                    <span>Send</span>
                                    <span class="material-symbols-outlined text-sm">send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 3. Okunmamışsa işaretle
        const dot = element.querySelector('.unread-dot');
        if (dot) {
            dot.remove();
            element.classList.remove('bg-pink-50/40', 'border-pink-100');
            element.classList.add('bg-white', 'border-transparent');

            fetch('/Message/MarkAsRead/' + id, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        const counter = document.getElementById('unreadCountBadge');
                        let currentCount = parseInt(counter.innerText);
                        if(currentCount > 0) counter.innerText = (currentCount - 1) + " NEW";
                    }
                });
        }
    }

    function sendReply(id, email) {
        const content = document.getElementById('replyContent').value;
        if(!content.trim()) {
            alert("Please enter a response.");
            return;
        }
        alert("Reply sent to: " + email);
        document.getElementById('replyContent').value = "";
    }

    function deleteMessage(id) {
        if (confirm("Bu mesajı silmek istediğinize emin misiniz?")) {
            fetch('/Message/DeleteMessage/' + id, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageCard = document.getElementById('msg-card-' + id);
                    if (messageCard) {
                        messageCard.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => messageCard.remove(), 300);
                    }
                    document.getElementById('detailPane').innerHTML = `
                        <div class="flex-1 flex flex-col items-center justify-center p-12 text-center bg-[#fffcfc] animate-in fade-in duration-500">
                            <div class="w-32 h-32 rounded-[48px] bg-white flex items-center justify-center mb-6 shadow-xl shadow-pink-100/50 border border-pink-50">
                                <span class="material-symbols-outlined text-5xl text-pink-200">delete_sweep</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">Message Deleted</h3>
                            <p class="text-sm text-gray-400 mt-2 max-w-xs leading-relaxed">The conversation has been removed.</p>
                        </div>
                    `;
                }
            });
        }
    }
</script>